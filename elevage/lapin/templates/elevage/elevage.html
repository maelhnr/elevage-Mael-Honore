{% extends 'base.html' %}

{% block title %}√âlevage de {{ elevage.nom_joueur }}{% endblock %}

{% block content %}


<div class="mb-4">
    <h1>√âlevage de {{ elevage.nom_joueur }} - Tour n¬∞{{ elevage.tour }}</h1>
    <p>
        <strong>Nourriture :</strong> {{ elevage.quantite_nourriture }} g<br>
        <strong>Cages :</strong> {{ elevage.nombre_cages }}<br>
        <strong>Argent :</strong> {{ elevage.argent }} ‚Ç¨
    </p>
</div>

{% if resultats_tour %}
    <div class="alert alert-info">
        <h2>R√©sum√© du tour</h2>
        {% if resultats_tour.morts_faim %}
            <p><strong>Morts de faim :</strong> {{ resultats_tour.morts_faim|length }}</p>
        {% endif %}
        {% if resultats_tour.morts_maladie %}
            <p><strong>Morts par maladie :</strong> {{ resultats_tour.morts_maladie|length }}</p>
        {% endif %}
        {% if resultats_tour.naissances %}
            <p><strong>Naissances :</strong> {{ resultats_tour.naissances|length }}</p>
        {% endif %}
        {% if lapins_vendus_m or lapins_vendus_f %}
            <p><strong>Lapins vendus :</strong> {{ lapins_vendus_m }} m√¢le(s), {{ lapins_vendus_f }} femelle(s)</p>
        {% endif %}
        {% if not resultats_tour.morts_faim and not resultats_tour.naissances and not resultats_tour.morts_maladie and not lapins_vendus_m and not lapins_vendus_f %}
            <p><em>Aucun √©v√©nement notable ce tour.</em></p>
        {% endif %}
    </div>
{% endif %}

{% if not fin_du_jeu %}
    <h2>Lapins pr√©sents ({{ individus|length }})</h2>
    <ul class="list-group mb-4">
        {% for individu in individus %}
            <li class="list-group-item">
                Sexe : {{ individu.get_sexe_display }} | √Çge : {{ individu.age }} mois{% if individu.etat == 'G' %} | Gravide{% endif %}
                <!-- Ajout de la sant√© pour chaque lapin -->
                 
                | Sant√© : 
                    {% if individu.sante.niveau_sante < 50 %}
                        <span style="color: red;">
                    {% else %}
                        <span style="color: green;">
                    {% endif %}
                        {{ individu.sante.niveau_sante }}%
                    </span>
                    | √âtat : {% if individu.sante.malade %}<strong style="color: red;">Malade</strong>{% else %}Sain{% endif %}
                    | Vaccin√© : {% if individu.sante.vaccin√© %}<span style="color: green;">Oui</span>{% else %}<span style="color: red;">Non</span>{% endif %}
            </li>
        {% empty %}
            <li class="list-group-item">Aucun individu dans cet √©levage.</li>
        {% endfor %}
    </ul>

    <h2>Actions du tour</h2>
    <form method="post" class="mb-5">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" name="action" value="valider" class="btn btn-primary mt-2">Valider le tour</button>
        <button type="submit" name="action" value="prevision" class="btn btn-secondary mt-2">Actualiser pr√©vision</button>
        <!-- Lien vers la page de gestion des soins des lapins -->
        <a href="{% url 'gestion_lapins' elevage.id %}" class="btn btn-info mt-3">Soigner les lapins</a>
    </form>

    <button onclick="toggleGraph()">Evolution de la population</button>

    <div id="chart-container" style="display: none;">
        <canvas id="myChart"></canvas>
    </div>
      
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        function toggleGraph() {
            const container = document.getElementById('chart-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
    </script>

    <script>
        var data = {{ data | safe }}
        const ctx = document.getElementById('myChart');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(i=> 'Tour ' + i.fields.numero),
                datasets: [{
                    label: 'Femelles',
                    data: data.map(i=>i.fields.nb_femelles_adultes),
                    borderColor: 'rgb(99, 255, 154)',
                    backgroundColor: 'rgba(99, 255, 146, 0.2)',
                },
                {
                    label: 'M√¢les',
                    data: data.map(i=>i.fields.nb_males_adultes),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                },
                {
                    label: 'Lapereaux',
                    data: data.map(i=>i.fields.nb_lapereaux),
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0 // √©vite les d√©cimales
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Population par cat√©gorie'
                    }
                }
            }
        });
    </script>
      

     <!-- Lien vers la page de gestion des soins des lapins -->
     <a href="{% url 'gestion_lapins' elevage.id %}" class="btn btn-info mt-3">Soigner les lapins</a>
    <h2>Param√®tres caract√©ristiques √©levage</h2>
    <ul>
        <li>Consommation de l'√©levage : {{ parametres.consommation }}g chaque mois</li>
        <li>Concentration : {{ parametres.concentration }} lapins par cage</li>
 
    </ul>

    <h2>Pr√©visions si vous ne faites rien (Estimations)</h2>
    <ul>
        <li>Naissances : {{ prevision.naissances }}</li>
        <li> Morts par faim : {{ prevision.morts_faim }}</li>
        <li> Morts maladie : {{ prevision.morts_maladie }}</li>
        <li> Lapins vivants apr√®s : {{ prevision.total_vivants_apres }}</li>
        <li> Nourriture restante : {{ prevision.nourriture_restante }} g</li>
    </ul>

    {% if prevision_3_tours %}
    <div class="mt-4">
        <h2>Pr√©visions sur 3 tours avec vos choix actuels</h2>
        <table border="1" class="table">
            <thead>
                <tr>
                    <th>Tour</th>
                    <th>Lapins Vivants</th>
                    <th>Nourriture Restante</th>
                    <th>Argent (‚Ç¨)</th>
                    <th>Naissances</th>
                    <th>Morts par Faim</th>
                    <th>Morts par Maladie</th>
                </tr>
            </thead>
            <tbody>
                {% for tour in prevision_3_tours %}
                    <tr>
                        <td>Tour {{ elevage.tour|add:forloop.counter }}</td>
                        <td>{{ tour.vivants_apres }}</td>
                        <td>{{ tour.nourriture_restante }}g</td>
                        <td>{{ tour.argent_apres }} ‚Ç¨</td>
                        <td>{{ tour.naissances }}</td>
                        <td>{{ tour.morts_faim }}</td>
                        <td>{{ tour.morts_maladie }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <h2>Conseil pour le tour suivant</h2>
    <ul>
        <li>[Manque de nourriture] Achat de nourriture : {{ proposition.achat_nourriture }}</li>
        <li>[Surpopulation] Achat de cages : {{ proposition.achat_cages }}</li>
        <li> [Surpopulation] Vente de lapins : {{ proposition.vente_lapins }}</li>
    </ul>

    <h2>Indicateurs cl√©s de l'√©levage</h2>
    <ul>
        <li>Taille de l'√©levage : {{ indicateurs.taille }}</li>
        <li> Taux de mortalit√© : {{ indicateurs.taux_mortalite }}</li>
        <li> Taux de vente : {{ indicateurs.taux_vente }}</li>
        <li> Taux d'occupation des cages : {{ indicateurs.occupation }}</li>
        <li> Age moyen des lapins : {{ indicateurs.age_moyen }}</li>
    </ul>

    
     
{% else %}
    <div class="alert alert-danger">
        <h2>üíÄ Fin de l'√©levage</h2>
        <p>Malheureusement, tous vos lapins sont morts ou ont √©t√© vendus... üêá</p>
        <p>Vous avez atteint le <strong>tour {{ elevage.tour }}</strong>.</p>
        <p><strong>Score final :</strong></p>
        <ul>
            <li>Argent restant : {{ elevage.argent }} ‚Ç¨</li>
            <li>Nourriture restante : {{ elevage.quantite_nourriture }} g</li>
            <li>Cages restantes : {{ elevage.nombre_cages }}</li>
        </ul>
        <a href="{% url 'nouveau_elevage' %}" class="btn btn-success mt-2">üîÅ Recommencer un √©levage</a>
        <a href="{% url 'liste_elevages' %}" class="btn btn-secondary mt-2">‚Üê Retour √† la liste</a>
    </div>
{% endif %}

{% endblock %}